<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç³»çµ±é¦–é  - æ±å³å¤§å­¸è³‡æ–™ç§‘å­¸ç³»å­¸ç”Ÿæœƒ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
    integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="/assets/css/style.css">
</head>

<body>
  <div class="container py-5">
    <!-- æ–°å¢æˆå“¡æŒ‰éˆ• (åƒ…ç®¡ç†å“¡å¯è¦‹) -->
    <div class="d-flex justify-content-center mb-3" id="addMemberSection" style="display: none;">
      <a href="/add-member" class="btn btn-success btn-lg">
        <i class="fas fa-user-plus me-2"></i>æ–°å¢æˆå“¡
      </a>
      </div>

    <!-- å°èˆªæŒ‰éˆ• -->
    <div class="d-flex justify-content-center flex-wrap gap-3 mb-4">
      <a href="/finance" class="btn btn-info">ğŸ’° è²¡å‹™éƒ¨</a>
      <a href="/activity" class="btn btn-info">ğŸ“… æ´»å‹•éƒ¨</a>
      <a href="/design" class="btn btn-info">ğŸ¨ ç¾å®£éƒ¨</a>
      <a href="/pr" class="btn btn-info">ğŸ“¢ å…¬é—œéƒ¨</a>
      <a href="/secretary" class="btn btn-info">ğŸ“‹ æ–‡æ›¸éƒ¨</a>
      <a href="/history" class="btn btn-info">ğŸ“Š æ­·å²è³‡æ–™</a>
      <a href="/admin" class="btn btn-dark" id="adminNavBtn" style="display: none;">ğŸ”§ ç³»çµ±ç®¡ç†</a>
      <button class="btn btn-danger" onclick="logout()">ğŸšª ç™»å‡º</button>
    </div>

    <!-- æ­¡è¿è¨Šæ¯ -->
    <div class="text-center mb-5">
      <h1 class="mb-3">ğŸ›ï¸ æ±å³å¤§å­¸è³‡æ–™ç§‘å­¸ç³»å­¸ç”Ÿæœƒç®¡ç†ç³»çµ±</h1>
      <p class="lead">æ­¡è¿ä½¿ç”¨æ•¸ä½åŒ–ç®¡ç†å¹³å°</p>
    </div>
    <!-- ç•¶å‰é¤˜é¡é¡¯ç¤º -->
    <div class="row mb-4">
      <div class="col-md-6 mx-auto">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="card-title">ğŸ’° ç•¶å‰é¤˜é¡</h5>
            <h2 class="text-success" id="totalBalance">NT$ 0</h2>
        </div>
        </div>
      </div>
    </div>

    <!-- åŠŸèƒ½æ¨¡çµ„ -->
    <div class="row g-4">
      <!-- è²¡å‹™éƒ¨ -->
      <div class="col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm">
          <div class="card-body text-center">
            <i class="fas fa-chart-line fa-3x text-success mb-3"></i>
            <h5 class="card-title">è²¡å‹™éƒ¨</h5>
            <p class="card-text">ç®¡ç†æ”¶æ”¯è¨˜éŒ„èˆ‡é ç®—</p>
            <a href="/finance" class="btn btn-success">é€²å…¥ç®¡ç†</a>
          </div>
        </div>
      </div>

      <!-- æ´»å‹•éƒ¨ -->
      <div class="col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm">
          <div class="card-body text-center">
            <i class="fas fa-calendar-star fa-3x text-primary mb-3"></i>
            <h5 class="card-title">æ´»å‹•éƒ¨</h5>
            <p class="card-text">è¦åŠƒèˆ‡åŸ·è¡Œå­¸æœƒæ´»å‹•</p>
            <a href="/activity" class="btn btn-primary">é€²å…¥ç®¡ç†</a>
          </div>
        </div>
      </div>

      <!-- ç¾å®£éƒ¨ -->
      <div class="col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm">
          <div class="card-body text-center">
            <i class="fas fa-palette fa-3x text-info mb-3"></i>
            <h5 class="card-title">ç¾å®£éƒ¨</h5>
            <p class="card-text">è¨­è¨ˆå®£å‚³ç‰©èˆ‡è¦–è¦ºè­˜åˆ¥</p>
            <a href="/design" class="btn btn-info">é€²å…¥ç®¡ç†</a>
          </div>
        </div>
      </div>

      <!-- å…¬é—œéƒ¨ -->
      <div class="col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm">
          <div class="card-body text-center">
            <i class="fas fa-bullhorn fa-3x text-warning mb-3"></i>
            <h5 class="card-title">å…¬é—œéƒ¨</h5>
            <p class="card-text">å°å¤–è¯ç¹«èˆ‡åˆä½œäº‹å‹™</p>
            <a href="/pr" class="btn btn-warning">é€²å…¥ç®¡ç†</a>
          </div>
        </div>
      </div>

      <!-- æ–‡æ›¸éƒ¨ -->
      <div class="col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm">
          <div class="card-body text-center">
            <i class="fas fa-file-contract fa-3x text-secondary mb-3"></i>
            <h5 class="card-title">æ–‡æ›¸éƒ¨</h5>
            <p class="card-text">æœƒè­°è¨˜éŒ„èˆ‡æ–‡ä»¶ç®¡ç†</p>
            <a href="/secretary" class="btn btn-secondary">é€²å…¥ç®¡ç†</a>
          </div>
        </div>
      </div>

      <!-- æ­·å²è³‡æ–™ -->
      <div class="col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm">
          <div class="card-body text-center">
            <i class="fas fa-database fa-3x text-dark mb-3"></i>
            <h5 class="card-title">æ­·å²è³‡æ–™</h5>
            <p class="card-text">æŸ¥çœ‹ç³»çµ±è¨˜éŒ„èˆ‡æ­·å²</p>
            <a href="/history" class="btn btn-dark">é€²å…¥ç®¡ç†</a>
          </div>
        </div>
      </div>
    </div>

    <!-- ç®¡ç†å“¡åŠŸèƒ½ -->
    <div id="adminSection" class="mt-5" style="display: none;">
      <h4 class="mb-3">ğŸ”§ ç³»çµ±ç®¡ç†</h4>
      <div class="row g-4">
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body text-center">
              <i class="fas fa-users-cog fa-3x text-danger mb-3"></i>
              <h5 class="card-title">ç³»çµ±ç®¡ç†</h5>
              <p class="card-text">ç®¡ç†ç³»çµ±è¨­å®šèˆ‡æ¬Šé™</p>
              <a href="/admin" class="btn btn-danger">é€²å…¥ç®¡ç†</a>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body text-center">
              <i class="fas fa-user-plus fa-3x text-success mb-3"></i>
              <h5 class="card-title">æ–°å¢æˆå“¡</h5>
              <p class="card-text">æ·»åŠ æ–°çš„ç³»çµ±ä½¿ç”¨è€…</p>
              <button class="btn btn-success" onclick="showAddMemberModal()">æ–°å¢æˆå“¡</button>
            </div>
          </div>
      </div>
      <div class="col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body text-center">
              <i class="fas fa-users fa-3x text-primary mb-3"></i>
              <h5 class="card-title">æˆå“¡åˆ—è¡¨</h5>
              <p class="card-text">æŸ¥çœ‹æ‰€æœ‰ç³»çµ±æˆå“¡</p>
              <button class="btn btn-primary" onclick="showMemberListModal()">æŸ¥çœ‹åˆ—è¡¨</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="mt-5 text-center">
      æ±å³å¤§å­¸è³‡æ–™ç§‘å­¸ç³»å­¸æœƒ &copy; 2025
    </footer>
  </div>

  <!-- æ–°å¢æˆå“¡æ¨¡æ…‹æ¡† -->
  <div class="modal fade" id="addMemberModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-user-plus me-2"></i>æ–°å¢ç³»çµ±æˆå“¡
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addMemberForm">
            <!-- åŸºæœ¬è³‡è¨Š -->
            <div class="row">
              <div class="col-12">
                <h6 class="border-bottom pb-2 mb-3">
                  <i class="fas fa-id-card me-2"></i>åŸºæœ¬è³‡è¨Š
                </h6>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="addUsername" class="form-label">
                    <i class="fas fa-user me-1"></i>å¸³è™Ÿ <span class="text-danger">*</span>
                  </label>
                  <input type="text" class="form-control" id="addUsername" placeholder="ä¾‹å¦‚ï¼šstudent001" required>
                  <div class="form-text">åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•¸å­—å’Œåº•ç·š</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="addPassword" class="form-label">
                    <i class="fas fa-lock me-1"></i>å¯†ç¢¼ <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <input type="password" class="form-control" id="addPassword" placeholder="è‡³å°‘6å€‹å­—ç¬¦" required>
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('addPassword')">
                      <i class="fas fa-eye" id="addPasswordToggleIcon"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="addFullName" class="form-label">
                    <i class="fas fa-signature me-1"></i>å§“å <span class="text-danger">*</span>
                  </label>
                  <input type="text" class="form-control" id="addFullName" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="addStudentId" class="form-label">
                    <i class="fas fa-id-badge me-1"></i>å­¸è™Ÿ <span class="text-danger">*</span>
                  </label>
                  <input type="text" class="form-control" id="addStudentId" placeholder="ä¾‹å¦‚ï¼š12345678" required>
                </div>
              </div>
            </div>



            <!-- ç³»çµ±æ¬Šé™ -->
            <div class="row">
              <div class="col-12">
                <h6 class="border-bottom pb-2 mb-3 mt-4">
                  <i class="fas fa-shield-alt me-2"></i>ç³»çµ±æ¬Šé™
                </h6>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="addRole" class="form-label">
                    <i class="fas fa-user-tag me-1"></i>è§’è‰² <span class="text-danger">*</span>
                  </label>
                  <select class="form-select" id="addRole" required>
                    <option value="">è«‹é¸æ“‡è§’è‰²</option>
                    <option value="admin">ç³»çµ±ç®¡ç†å“¡</option>
                    <option value="secretary">ç§˜æ›¸è™•</option>
                    <option value="finance">è²¡å‹™éƒ¨</option>
                    <option value="activity">æ´»å‹•éƒ¨</option>
                    <option value="design">ç¾å®£éƒ¨</option>
                    <option value="pr">å…¬é—œéƒ¨</option>
                    <option value="member">ä¸€èˆ¬æˆå“¡</option>
                  </select>
                </div>
              </div>

            </div>

            <!-- ç‹€æ…‹è¨­å®š -->
            <div class="row">
              <div class="col-12">
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="addIsActive" checked>
                    <label class="form-check-label" for="addIsActive">
                      <i class="fas fa-toggle-on me-1"></i>å•Ÿç”¨å¸³è™Ÿ
                    </label>
                    <div class="form-text">å–æ¶ˆå‹¾é¸å°‡å»ºç«‹åœç”¨ç‹€æ…‹çš„å¸³è™Ÿ</div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary-modern" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>å–æ¶ˆ
          </button>
          <button type="button" class="btn-primary-modern" onclick="submitAddMember()">
            <i class="fas fa-user-plus me-2"></i>æ–°å¢æˆå“¡
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- æˆå“¡åˆ—è¡¨æ¨¡æ…‹æ¡† -->
  <div class="modal fade" id="memberListModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-users me-2"></i>ç³»çµ±æˆå“¡åˆ—è¡¨
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h6 class="mb-0">ç¸½å…± <span id="memberCount">0</span> ä½æˆå“¡</h6>
            </div>
            <button class="btn-primary-modern btn-sm" onclick="refreshMemberList()">
              <i class="fas fa-sync-alt me-1"></i>é‡æ–°æ•´ç†
            </button>
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>å¸³è™Ÿ</th>
                  <th>å§“å</th>
                  <th>å­¸è™Ÿ</th>
                  <th>è§’è‰²</th>
                  <th>ç‹€æ…‹</th>
                  <th>å»ºç«‹æ™‚é–“</th>
                </tr>
              </thead>
              <tbody id="memberListBody">
                <!-- å‹•æ…‹è¼‰å…¥æˆå“¡åˆ—è¡¨ -->
              </tbody>
            </table>
          </div>
          
          <div id="memberListLoading" class="text-center py-4" style="display: none;">
            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
            <p class="mt-2 text-muted">è¼‰å…¥ä¸­...</p>
          </div>
          
          <div id="memberListEmpty" class="text-center py-4" style="display: none;">
            <i class="fas fa-users-slash fa-2x text-muted"></i>
            <p class="mt-2 text-muted">ç›®å‰æ²’æœ‰æˆå“¡è³‡æ–™</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary-modern" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>é—œé–‰
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/js/globalErrorHandler.js"></script>
  <script src="/assets/js/common.js"></script>
  <script src="/assets/js/finance.js"></script>
  <script>
    // æª¢æŸ¥ç”¨æˆ¶èªè­‰ç‹€æ…‹
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        const response = await fetch('/api/auth/check', {
          method: 'GET',
          credentials: 'include'
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.authenticated && data.user) {
            // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œé¡¯ç¤ºç®¡ç†å“¡åŠŸèƒ½
            if (data.user.role === 'admin') {
              document.getElementById('adminSection').style.display = 'block';
              document.getElementById('adminNavBtn').style.display = 'inline-block';
              document.getElementById('addMemberSection').style.display = 'flex';
            }
            
            // å»¶é²è¼‰å…¥çµ±è¨ˆæ•¸æ“šï¼Œç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½å·²è¼‰å…¥
            setTimeout(() => {
              loadDashboardStats();
            }, 500);
          } else {
            console.log('ç”¨æˆ¶æœªèªè­‰ï¼Œç­‰å¾…å¾Œç«¯é‡å®šå‘');
          }
        } else {
          console.error('èªè­‰æª¢æŸ¥å¤±æ•—ï¼ŒHTTPç‹€æ…‹:', response.status);
        }
      } catch (error) {
        console.error('èªè­‰æª¢æŸ¥éŒ¯èª¤:', error);
      }
    });

    // è¼‰å…¥å„€è¡¨æ¿çµ±è¨ˆæ•¸æ“š
    async function loadDashboardStats() {
      try {
        // è¼‰å…¥è²¡å‹™çµ±è¨ˆ
        const financeResponse = await fetch('/api/finance/summary');
        if (financeResponse.ok) {
          const financeSummary = await financeResponse.json();
          
          // æ›´æ–°ç•¶å‰é¤˜é¡
          const totalBalanceEl = document.getElementById('totalBalance');
          if (totalBalanceEl) {
            totalBalanceEl.textContent = `NT$ ${financeSummary.balance.toFixed(0)}`;
          }
        }
      } catch (error) {
        console.log('è¼‰å…¥çµ±è¨ˆæ•¸æ“šå¤±æ•—:', error.message);
        
        // è¨­ç½®é è¨­å€¼
        const totalBalanceEl = document.getElementById('totalBalance');
        if (totalBalanceEl) {
          totalBalanceEl.textContent = 'NT$ 0';
        }
      }
    }

    // ç™»å‡ºåŠŸèƒ½
    function logout() {
      if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        fetch('/api/auth/logout', {
          method: 'POST',
          credentials: 'include'
        }).then(() => {
          window.location.href = '/';
        }).catch(() => {
          window.location.href = '/';
        });
      }
    }

    // æ–°å¢æˆå“¡ç›¸é—œåŠŸèƒ½
    function showAddMemberModal() {
      const modal = new bootstrap.Modal(document.getElementById('addMemberModal'));
      // é‡ç½®è¡¨å–®
      document.getElementById('addMemberForm').reset();
      // é è¨­å•Ÿç”¨ç‹€æ…‹
      document.getElementById('addIsActive').checked = true;
      modal.show();
    }

    // åˆ‡æ›å¯†ç¢¼é¡¯ç¤º/éš±è—
    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      const icon = document.getElementById(inputId + 'ToggleIcon');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
      } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
      }
    }

    // æäº¤æ–°å¢æˆå“¡è¡¨å–®
    async function submitAddMember() {
      const form = document.getElementById('addMemberForm');
      
      // åŸºæœ¬é©—è­‰
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // æ”¶é›†è¡¨å–®è³‡æ–™
      const formData = {
        username: document.getElementById('addUsername').value.trim(),
        password: document.getElementById('addPassword').value,
        full_name: document.getElementById('addFullName').value.trim(),
        student_id: document.getElementById('addStudentId').value.trim(),
        role: document.getElementById('addRole').value,
        is_active: document.getElementById('addIsActive').checked ? 1 : 0
      };

      // å‰ç«¯é©—è­‰
      if (!validateMemberData(formData)) {
        return;
      }

      try {
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        const submitBtn = document.querySelector('#addMemberModal .btn-primary-modern');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>å»ºç«‹ä¸­...';
        submitBtn.disabled = true;

        // ç™¼é€è«‹æ±‚
        const response = await fetch('/api/admin/users', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok) {
          // æˆåŠŸ
          showNotification('æˆå“¡æ–°å¢æˆåŠŸï¼', 'success');
          
          // é—œé–‰æ¨¡æ…‹æ¡†
          const modal = bootstrap.Modal.getInstance(document.getElementById('addMemberModal'));
          modal.hide();
          
          // é‡ç½®è¡¨å–®
          form.reset();
        } else {
          // å¤±æ•—
          showNotification(result.message || 'æ–°å¢æˆå“¡å¤±æ•—', 'error');
        }

      } catch (error) {
        console.error('æ–°å¢æˆå“¡éŒ¯èª¤:', error);
        showNotification('ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      } finally {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        const submitBtn = document.querySelector('#addMemberModal .btn-primary-modern');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }

    // é©—è­‰æˆå“¡è³‡æ–™
    function validateMemberData(data) {
      // å¸³è™Ÿæ ¼å¼é©—è­‰
      if (!/^[a-zA-Z0-9_]+$/.test(data.username)) {
        showNotification('å¸³è™Ÿåªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•¸å­—å’Œåº•ç·š', 'error');
        return false;
      }

      // å¯†ç¢¼é•·åº¦é©—è­‰
      if (data.password.length < 6) {
        showNotification('å¯†ç¢¼è‡³å°‘éœ€è¦6å€‹å­—ç¬¦', 'error');
        return false;
      }

      // å­¸è™Ÿæ ¼å¼é©—è­‰ï¼ˆå‡è¨­8ä½æ•¸å­—ï¼‰
      if (!/^\d{8}$/.test(data.student_id)) {
        showNotification('å­¸è™Ÿæ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰ç‚º8ä½æ•¸å­—', 'error');
        return false;
      }

      return true;
    }

    // é€šçŸ¥å‡½æ•¸
    function showNotification(message, type = 'info') {
      // ç§»é™¤ç¾æœ‰é€šçŸ¥
      const existingNotification = document.querySelector('.notification-toast');
      if (existingNotification) {
        existingNotification.remove();
      }

      // å‰µå»ºé€šçŸ¥å…ƒç´ 
      const notification = document.createElement('div');
      notification.className = `notification-toast alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed`;
      notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 400px;
        animation: slideInRight 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      `;
      notification.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
          <span>${message}</span>
          <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.animation = 'slideOutRight 0.3s ease';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }
      }, 3000);
    }

    // é¡¯ç¤ºæˆå“¡åˆ—è¡¨æ¨¡æ…‹æ¡†
    function showMemberListModal() {
      const modal = new bootstrap.Modal(document.getElementById('memberListModal'));
      modal.show();
      loadMemberList();
    }

    // è¼‰å…¥æˆå“¡åˆ—è¡¨
    async function loadMemberList() {
      const loadingEl = document.getElementById('memberListLoading');
      const emptyEl = document.getElementById('memberListEmpty');
      const bodyEl = document.getElementById('memberListBody');
      const countEl = document.getElementById('memberCount');

      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      loadingEl.style.display = 'block';
      emptyEl.style.display = 'none';
      bodyEl.innerHTML = '';

      try {
        const response = await fetch('/api/admin/users', {
          method: 'GET',
          credentials: 'include'
        });
        
        const result = await response.json();

        if (response.ok && result.success) {
          const members = result.data || [];
          countEl.textContent = members.length;

          if (members.length === 0) {
            emptyEl.style.display = 'block';
          } else {
            bodyEl.innerHTML = members.map(member => `
              <tr>
                <td><strong>${escapeHtml(member.username)}</strong></td>
                <td>${escapeHtml(member.full_name || member.name || '-')}</td>
                <td>${escapeHtml(member.student_id || '-')}</td>
                <td>
                  <span class="badge ${getRoleBadgeClass(member.role)}">${getRoleDisplayName(member.role)}</span>
                </td>
                <td>
                  <span class="badge ${member.is_active ? 'bg-success' : 'bg-secondary'}">
                    ${member.is_active ? 'å•Ÿç”¨' : 'åœç”¨'}
                  </span>
                </td>
                <td>${formatDateTime(member.created_at)}</td>
              </tr>
            `).join('');
          }
        } else {
          showNotification(result.message || 'è¼‰å…¥æˆå“¡åˆ—è¡¨å¤±æ•—', 'error');
          emptyEl.style.display = 'block';
        }

      } catch (error) {
        console.error('è¼‰å…¥æˆå“¡åˆ—è¡¨éŒ¯èª¤:', error);
        showNotification('è¼‰å…¥æˆå“¡åˆ—è¡¨å¤±æ•—', 'error');
        emptyEl.style.display = 'block';
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    // é‡æ–°æ•´ç†æˆå“¡åˆ—è¡¨
    function refreshMemberList() {
      loadMemberList();
    }

    // è¼”åŠ©å‡½æ•¸
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getRoleBadgeClass(role) {
      switch (role) {
        case 'admin': return 'bg-danger';
        case 'secretary': return 'bg-primary';
        case 'finance': return 'bg-success';
        case 'activity': return 'bg-warning';
        case 'design': return 'bg-info';
        case 'pr': return 'bg-secondary';
        default: return 'bg-light text-dark';
      }
    }

    function getRoleDisplayName(role) {
      switch (role) {
        case 'admin': return 'ç³»çµ±ç®¡ç†å“¡';
        case 'secretary': return 'ç§˜æ›¸è™•';
        case 'finance': return 'è²¡å‹™éƒ¨';
        case 'activity': return 'æ´»å‹•éƒ¨';
        case 'design': return 'ç¾å®£éƒ¨';
        case 'pr': return 'å…¬é—œéƒ¨';
        case 'member': return 'ä¸€èˆ¬æˆå“¡';
        default: return role || 'æœªçŸ¥';
      }
    }

    function formatDateTime(dateString) {
      if (!dateString) return '-';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW', {
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (error) {
        return dateString;
      }
    }
  </script>

  <style>
    /* é€šçŸ¥å‹•ç•« */
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    /* æ¨¡æ…‹æ¡†æ¨£å¼ */
    .modal-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
    }

    /* éŸ¿æ‡‰å¼å„ªåŒ– */
    @media (max-width: 768px) {
      .modal-dialog {
        margin: 0.5rem;
      }
      
      .modal-lg {
        max-width: none;
      }
    }
  </style>
</body>

</html>