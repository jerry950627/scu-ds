<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–‡æ›¸éƒ¨ç®¡ç†</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="/assets/css/style.css">
</head>

<body>
  <div class="container py-5">
    <!-- å°èˆªæŒ‰éˆ• -->
    <div class="d-flex justify-content-center flex-wrap gap-3 mb-4">
      <a href="/dashboard" class="btn btn-light">ğŸ  é¦–é </a>
      <a href="/activity" class="btn btn-info">æ´»å‹•éƒ¨</a>
      <a href="/design" class="btn btn-info">ç¾å®£éƒ¨</a>
      <a href="/pr" class="btn btn-info">å…¬é—œéƒ¨</a>
      <a href="/finance" class="btn btn-info">è²¡å‹™éƒ¨</a>
      <a href="/history" class="btn btn-info">æ­·å²è³‡æ–™</a>
      <a href="/admin" class="btn btn-dark">ç³»çµ±ç®¡ç†</a>
      <button class="btn btn-success" onclick="exportSecretaryData()">ğŸ“¤ åŒ¯å‡ºæ•¸æ“š</button>
    </div>

    <div class="text-center mb-4">
      <h1>ğŸ“‹ æ–‡æ›¸éƒ¨ç®¡ç†</h1>
    </div>

    <!-- æœƒè­°è¨˜éŒ„ç®¡ç† -->
    <div class="card mb-4">
      <div class="card-header">ğŸ“‹ æœƒè­°è¨˜éŒ„ç®¡ç†</div>
      <div class="card-body">
        <!-- æœƒè­°è¨˜éŒ„æ“ä½œè¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
        <div id="meetingMessages" class="mb-3"></div>


        <form id="meetingForm" class="mb-3">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="meetingTopic" class="form-label">æœƒè­°ä¸»é¡Œ</label>
              <input type="text" class="form-control" id="meetingTopic" name="topic" required placeholder="è«‹è¼¸å…¥æœƒè­°ä¸»é¡Œ">
            </div>
            <div class="col-md-6">
              <label for="meetingDate" class="form-label">æœƒè­°æ—¥æœŸ</label>
              <input type="date" class="form-control" id="meetingDate" name="date" required>
            </div>
            <div class="col-12">
              <label for="meetingContent" class="form-label">æœƒè­°å…§å®¹</label>
              <textarea class="form-control" id="meetingContent" name="content" rows="8" required></textarea>
            </div>
            <div class="col-12">
              <label for="meetingFile" class="form-label">é™„ä»¶</label>
              <input type="file" class="form-control" id="meetingFile" name="attachment">
              <div class="progress mt-2">
                <div class="progress-bar" role="progressbar" id="meetingProgress" style="width: 0%"></div>
              </div>
            </div>
            <div class="col-12 text-end">
              <button type="submit" class="btn btn-primary">ğŸ’¾ å„²å­˜æœƒè­°è¨˜éŒ„</button>
            </div>
          </div>
        </form>

        <ul class="list-group" id="meetingList"></ul>
      </div>
    </div>

    <!-- æ´»å‹•è¨˜éŒ„ç®¡ç† -->
    <div class="card mb-4">
      <div class="card-header">ğŸ‰ æ´»å‹•è¨˜éŒ„ç®¡ç†</div>
      <div class="card-body">
        <!-- æ´»å‹•è¨˜éŒ„æ“ä½œè¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
        <div id="activityMessages" class="mb-3"></div>

        <form id="activityForm" class="mb-3">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="activityTitle" class="form-label">æ´»å‹•åç¨±</label>
              <input type="text" class="form-control" id="activityTitle" name="title" required placeholder="è«‹è¼¸å…¥æ´»å‹•åç¨±">
            </div>
            <div class="col-12">
              <label for="activityDescription" class="form-label">æ´»å‹•æè¿°</label>
              <textarea class="form-control" id="activityDescription" name="description" rows="5" required
                placeholder="è«‹è¼¸å…¥æ´»å‹•æè¿°"></textarea>
            </div>
            <div class="col-md-6">
              <label for="activityProposal" class="form-label">æ´»å‹•ä¼åŠƒæ›¸</label>
              <input type="file" class="form-control" id="activityProposal" name="proposal" accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
            </div>
            <div class="col-md-6">
              <label for="activityDetail" class="form-label">æ´»å‹•ç›¸é—œæª”æ¡ˆ</label>
              <input type="file" class="form-control" id="activityDetail" name="detail" accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
            </div>
            <div class="progress mt-2">
              <div class="progress-bar" role="progressbar" id="activityProgress" style="width: 0%"></div>
            </div>
            <div class="col-12 text-end">
              <button type="submit" class="btn btn-primary">ğŸ“¸ å„²å­˜æ´»å‹•è¨˜éŒ„</button>
            </div>
          </div>
        </form>

        <ul class="list-group" id="activityList"></ul>
      </div>
    </div>

    <footer class="mt-5 text-center">
      æ±å³å¤§å­¸è³‡æ–™ç§‘å­¸ç³»å­¸æœƒ &copy; 2025
    </footer>
  </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/js/globalErrorHandler.js"></script>
    <script src="/assets/js/common.js"></script>
    <script src="/assets/js/secretary.js"></script>

    <script>
      // è¨­å®šæœƒè­°æ—¥æœŸé è¨­ç‚ºä»Šå¤©
      document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('meetingDate').value = today;
      });

      // åŒ¯å‡ºæ•¸æ“šåŠŸèƒ½
      async function exportSecretaryData() {
        try {
          // ç²å–æœƒè­°è¨˜éŒ„æ•¸æ“š
          const meetingsResponse = await fetch('/api/secretary/meetings');
          const meetings = await meetingsResponse.json();
          
          // ç²å–æ´»å‹•è¨˜éŒ„æ•¸æ“š
          const activitiesResponse = await fetch('/api/secretary/activities');
          const activities = await activitiesResponse.json();
          
          // å‰µå»ºCSVå…§å®¹
          let csvContent = '\uFEFF'; // BOM for UTF-8
          
          // æœƒè­°è¨˜éŒ„éƒ¨åˆ†
          csvContent += 'æœƒè­°è¨˜éŒ„\n';
          csvContent += 'æœƒè­°ä¸»é¡Œ,æœƒè­°æ—¥æœŸ,æœƒè­°å…§å®¹,é™„ä»¶\n';
          
          meetings.forEach(meeting => {
            const topic = (meeting.topic || '').replace(/"/g, '""');
            const date = meeting.date || '';
            const content = (meeting.content || '').replace(/"/g, '""').replace(/\n/g, ' ');
            const attachment = meeting.filename ? 'æœ‰é™„ä»¶' : 'ç„¡é™„ä»¶';
            csvContent += `"${topic}","${date}","${content}","${attachment}"\n`;
          });
          
          csvContent += '\næ´»å‹•è¨˜éŒ„\n';
          csvContent += 'æ´»å‹•åç¨±,æ´»å‹•æè¿°,ä¼åŠƒæ›¸,ç›¸é—œæª”æ¡ˆ,å»ºç«‹æ—¥æœŸ\n';
          
          activities.forEach(activity => {
            const title = (activity.title || '').replace(/"/g, '""');
            const description = (activity.description || '').replace(/"/g, '""').replace(/\n/g, ' ');
            const proposal = activity.proposal_path ? 'æœ‰ä¼åŠƒæ›¸' : 'ç„¡ä¼åŠƒæ›¸';
            const detail = activity.detail_path ? 'æœ‰ç›¸é—œæª”æ¡ˆ' : 'ç„¡ç›¸é—œæª”æ¡ˆ';
            const createdAt = new Date(activity.created_at).toLocaleDateString('zh-TW');
            csvContent += `"${title}","${description}","${proposal}","${detail}","${createdAt}"\n`;
          });
          
          // å‰µå»ºä¸¦ä¸‹è¼‰æ–‡ä»¶
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', `æ–‡æ›¸éƒ¨æ•¸æ“š_${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          alert('æ•¸æ“šåŒ¯å‡ºæˆåŠŸï¼');
        } catch (error) {
          console.error('åŒ¯å‡ºå¤±æ•—:', error);
          alert('åŒ¯å‡ºå¤±æ•—: ' + error.message);
        }
      }
    </script>
  </body>

</html>