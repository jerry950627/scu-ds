<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°å¢æˆå“¡</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="/assets/css/style.css">
</head>

<body>
  <div class="container py-5">
    <!-- å°èˆªæŒ‰éˆ• -->
    <div class="d-flex justify-content-center flex-wrap gap-3 mb-4">
      <a href="/dashboard" class="btn btn-light">ğŸ  é¦–é </a>
      <a href="/activity" class="btn btn-info">æ´»å‹•éƒ¨</a>
      <a href="/design" class="btn btn-info">ç¾å®£éƒ¨</a>
      <a href="/pr" class="btn btn-info">å…¬é—œéƒ¨</a>
      <a href="/secretary" class="btn btn-info">æ–‡æ›¸éƒ¨</a>
      <a href="/finance" class="btn btn-info">è²¡å‹™éƒ¨</a>
      <a href="/history" class="btn btn-info">æ­·å²è³‡æ–™</a>
      <a href="/admin" class="btn btn-dark">ç³»çµ±ç®¡ç†</a>
    </div>

    <div class="text-center mb-4">
      <h1>ğŸ‘¥ æ–°å¢ç³»çµ±æˆå“¡</h1>
      <p class="lead">å¡«å¯«ä»¥ä¸‹è³‡è¨Šä¾†å»ºç«‹æ–°çš„ç³»çµ±ä½¿ç”¨è€…</p>
    </div>

    <!-- æ–°å¢æˆå“¡è¡¨å–® -->
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-user-plus me-2"></i>æˆå“¡è³‡è¨Š
            </h5>
          </div>
          <div class="card-body">
            <!-- è¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
            <div id="alertContainer"></div>

            <form id="addMemberForm">
              <!-- åŸºæœ¬è³‡è¨Š -->
              <div class="mb-4">
                <h6 class="border-bottom pb-2 mb-3">
                  <i class="fas fa-id-card me-2"></i>åŸºæœ¬è³‡è¨Š
                </h6>
                
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="username" class="form-label">
                        <i class="fas fa-user me-1"></i>å¸³è™Ÿ <span class="text-danger">*</span>
                      </label>
                      <input type="text" class="form-control" id="username" name="username" required 
                             placeholder="ä¾‹å¦‚ï¼šstudent001" maxlength="50">
                      <div class="form-text">åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•¸å­—å’Œåº•ç·š</div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="password" class="form-label">
                        <i class="fas fa-lock me-1"></i>å¯†ç¢¼ <span class="text-danger">*</span>
                      </label>
                      <div class="input-group">
                        <input type="password" class="form-control" id="password" name="password" required 
                               placeholder="è‡³å°‘6å€‹å­—ç¬¦" minlength="6">
                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('password')">
                          <i class="fas fa-eye" id="passwordToggleIcon"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="fullName" class="form-label">
                        <i class="fas fa-signature me-1"></i>å§“å <span class="text-danger">*</span>
                      </label>
                      <input type="text" class="form-control" id="fullName" name="full_name" required 
                             placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" maxlength="100">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="studentId" class="form-label">
                        <i class="fas fa-id-badge me-1"></i>å­¸è™Ÿ <span class="text-danger">*</span>
                      </label>
                      <input type="text" class="form-control" id="studentId" name="student_id" required 
                             placeholder="ä¾‹å¦‚ï¼š12345678" maxlength="20">
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="email" class="form-label">
                        <i class="fas fa-envelope me-1"></i>é›»å­éƒµä»¶
                      </label>
                      <input type="email" class="form-control" id="email" name="email" 
                             placeholder="ä¾‹å¦‚ï¼šstudent@scu.edu.tw" maxlength="100">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="phone" class="form-label">
                        <i class="fas fa-phone me-1"></i>è¯çµ¡é›»è©±
                      </label>
                      <input type="tel" class="form-control" id="phone" name="phone" 
                             placeholder="ä¾‹å¦‚ï¼š0912345678" maxlength="20">
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="department" class="form-label">
                        <i class="fas fa-building me-1"></i>æ‰€å±¬éƒ¨é–€ <span class="text-danger">*</span>
                      </label>
                      <select class="form-select" id="department" name="department" required>
                        <option value="è³‡æ–™ç§‘å­¸ç³»" selected>è³‡æ–™ç§‘å­¸ç³»</option>
                        <option value="è²¡å‹™éƒ¨">è²¡å‹™éƒ¨</option>
                        <option value="æ´»å‹•éƒ¨">æ´»å‹•éƒ¨</option>
                        <option value="ç¾å®£éƒ¨">ç¾å®£éƒ¨</option>
                        <option value="å…¬é—œéƒ¨">å…¬é—œéƒ¨</option>
                        <option value="æ–‡æ›¸éƒ¨">æ–‡æ›¸éƒ¨</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="grade" class="form-label">
                        <i class="fas fa-graduation-cap me-1"></i>å¹´ç´š
                      </label>
                      <select class="form-select" id="grade" name="grade">
                        <option value="">è«‹é¸æ“‡å¹´ç´š</option>
                        <option value="1">å¤§ä¸€</option>
                        <option value="2">å¤§äºŒ</option>
                        <option value="3">å¤§ä¸‰</option>
                        <option value="4">å¤§å››</option>
                        <option value="5">ç ”ä¸€</option>
                        <option value="6">ç ”äºŒ</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ç³»çµ±æ¬Šé™ -->
              <div class="mb-4">
                <h6 class="border-bottom pb-2 mb-3">
                  <i class="fas fa-shield-alt me-2"></i>ç³»çµ±æ¬Šé™
                </h6>

                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="role" class="form-label">
                        <i class="fas fa-user-tag me-1"></i>è§’è‰² <span class="text-danger">*</span>
                      </label>
                      <select class="form-select" id="role" name="role" required>
                        <option value="member" selected>ä¸€èˆ¬æˆå“¡</option>
                        <option value="admin">ç³»çµ±ç®¡ç†å“¡</option>
                        <option value="finance">è²¡å‹™éƒ¨æˆå“¡</option>
                        <option value="activity">æ´»å‹•éƒ¨æˆå“¡</option>
                        <option value="design">ç¾å®£éƒ¨æˆå“¡</option>
                        <option value="pr">å…¬é—œéƒ¨æˆå“¡</option>
                        <option value="secretary">æ–‡æ›¸éƒ¨æˆå“¡</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="fas fa-toggle-on me-1"></i>å¸³è™Ÿç‹€æ…‹
                      </label>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="isActive" name="is_active" checked>
                        <label class="form-check-label" for="isActive">
                          å•Ÿç”¨å¸³è™Ÿ
                        </label>
                        <div class="form-text">å–æ¶ˆå‹¾é¸å°‡å»ºç«‹åœç”¨ç‹€æ…‹çš„å¸³è™Ÿ</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- æäº¤æŒ‰éˆ• -->
              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="/dashboard" class="btn btn-secondary me-md-2">
                  <i class="fas fa-times me-2"></i>å–æ¶ˆ
                </a>
                <button type="submit" class="btn btn-success" id="submitBtn">
                  <i class="fas fa-user-plus me-2"></i>å»ºç«‹æˆå“¡
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <footer class="mt-5 text-center">
      æ±å³å¤§å­¸è³‡æ–™ç§‘å­¸ç³»å­¸æœƒ &copy; 2025
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/js/globalErrorHandler.js"></script>
  <script src="/assets/js/common.js"></script>
  
  <script>
    // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
      // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
      checkAdminPermission();
    });

    // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
    async function checkAdminPermission() {
      try {
        const response = await fetch('/api/auth/check', {
          method: 'GET',
          credentials: 'include'
        });
        
        if (response.ok) {
          const data = await response.json();
          if (!data.authenticated || data.user.role !== 'admin') {
            showAlert('æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤é é¢', 'danger');
            setTimeout(() => {
              window.location.href = '/dashboard';
            }, 2000);
          }
        } else {
          window.location.href = '/';
        }
      } catch (error) {
        console.error('æ¬Šé™æª¢æŸ¥å¤±æ•—:', error);
        window.location.href = '/';
      }
    }

    // åˆ‡æ›å¯†ç¢¼é¡¯ç¤º/éš±è—
    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      const icon = document.getElementById(inputId + 'ToggleIcon');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
      } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
      }
    }

    // è¡¨å–®æäº¤è™•ç†
    document.getElementById('addMemberForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      // æ¸…é™¤ä¹‹å‰çš„è¨Šæ¯
      clearAlerts();

      // æ”¶é›†è¡¨å–®è³‡æ–™
      const formData = new FormData(this);
      const data = {};
      
      // è½‰æ›è¡¨å–®æ•¸æ“š
      for (let [key, value] of formData.entries()) {
        data[key] = value.trim();
      }
      
      // è™•ç† checkbox
      data.is_active = document.getElementById('isActive').checked ? 1 : 0;

      // åŸºæœ¬é©—è­‰
      if (!validateFormData(data)) {
        return;
      }

      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>å»ºç«‹ä¸­...';
      submitBtn.disabled = true;

      try {
        // ç™¼é€è«‹æ±‚
        const response = await fetch('/api/admin/users', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // æˆåŠŸ
          showAlert('æˆå“¡å»ºç«‹æˆåŠŸï¼å³å°‡è¿”å›é¦–é ...', 'success');
          
          // æ¸…ç©ºè¡¨å–®
          this.reset();
          document.getElementById('department').value = 'è³‡æ–™ç§‘å­¸ç³»';
          document.getElementById('role').value = 'member';
          document.getElementById('isActive').checked = true;
          
          // 2ç§’å¾Œè·³è½‰
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 2000);
        } else {
          // å¤±æ•—
          showAlert(result.message || 'å»ºç«‹æˆå“¡å¤±æ•—', 'danger');
        }

      } catch (error) {
        console.error('å»ºç«‹æˆå“¡éŒ¯èª¤:', error);
        showAlert('ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'danger');
      } finally {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // é©—è­‰è¡¨å–®è³‡æ–™
    function validateFormData(data) {
      // å¿…å¡«æ¬„ä½æª¢æŸ¥
      const requiredFields = ['username', 'password', 'full_name', 'student_id', 'department', 'role'];
      for (const field of requiredFields) {
        if (!data[field]) {
          showAlert(`è«‹å¡«å¯«${getFieldName(field)}`, 'warning');
          return false;
        }
      }

      // å¸³è™Ÿæ ¼å¼é©—è­‰
      if (!/^[a-zA-Z0-9_]+$/.test(data.username)) {
        showAlert('å¸³è™Ÿåªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•¸å­—å’Œåº•ç·š', 'warning');
        return false;
      }

      // å¯†ç¢¼é•·åº¦é©—è­‰
      if (data.password.length < 6) {
        showAlert('å¯†ç¢¼è‡³å°‘éœ€è¦6å€‹å­—ç¬¦', 'warning');
        return false;
      }

      // å­¸è™Ÿæ ¼å¼é©—è­‰ï¼ˆå‡è¨­8ä½æ•¸å­—æˆ–å­—æ¯æ•¸å­—çµ„åˆï¼‰
      if (data.student_id && (data.student_id.length < 3 || data.student_id.length > 20)) {
        showAlert('å­¸è™Ÿæ ¼å¼ä¸æ­£ç¢º', 'warning');
        return false;
      }

      // é›»å­éƒµä»¶æ ¼å¼é©—è­‰
      if (data.email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(data.email)) {
          showAlert('é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º', 'warning');
          return false;
        }
      }

      return true;
    }

    // å–å¾—æ¬„ä½ä¸­æ–‡åç¨±
    function getFieldName(field) {
      const fieldNames = {
        'username': 'å¸³è™Ÿ',
        'password': 'å¯†ç¢¼',
        'full_name': 'å§“å',
        'student_id': 'å­¸è™Ÿ',
        'department': 'æ‰€å±¬éƒ¨é–€',
        'role': 'è§’è‰²'
      };
      return fieldNames[field] || field;
    }

    // é¡¯ç¤ºæç¤ºè¨Šæ¯
    function showAlert(message, type = 'info') {
      const alertContainer = document.getElementById('alertContainer');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        <i class="fas fa-${getAlertIcon(type)} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      alertContainer.appendChild(alertDiv);

      // è‡ªå‹•æ¶ˆå¤±ï¼ˆé™¤äº†éŒ¯èª¤è¨Šæ¯ï¼‰
      if (type !== 'danger') {
        setTimeout(() => {
          const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
          alert.close();
        }, 5000);
      }

      // æ»¾å‹•åˆ°é ‚éƒ¨é¡¯ç¤ºè¨Šæ¯
      alertContainer.scrollIntoView({ behavior: 'smooth' });
    }

    // å–å¾—æç¤ºåœ–ç¤º
    function getAlertIcon(type) {
      const icons = {
        'success': 'check-circle',
        'danger': 'exclamation-triangle',
        'warning': 'exclamation-circle',
        'info': 'info-circle'
      };
      return icons[type] || 'info-circle';
    }

    // æ¸…é™¤æ‰€æœ‰æç¤ºè¨Šæ¯
    function clearAlerts() {
      const alertContainer = document.getElementById('alertContainer');
      alertContainer.innerHTML = '';
    }
  </script>
</body>

</html> 