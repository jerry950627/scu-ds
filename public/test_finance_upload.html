<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²¡å‹™ä¸Šå‚³æ¸¬è©¦</title>
    <link rel="icon" type="image/x-icon" href="/assets/images/ds.jpg">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        input, select, textarea { margin: 5px 0; padding: 5px; width: 200px; }
        #results { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ§ª è²¡å‹™è³‡æ–™ä¸Šå‚³æ¸¬è©¦é é¢</h1>
    
    <div class="test-section">
        <h3>ğŸ“‹ æ¸¬è©¦è¡¨å–®</h3>
        <form id="testForm">
            <div>
                <label>é¡å‹ *:</label>
                <select id="type" required>
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="income">æ”¶å…¥</option>
                    <option value="expense">æ”¯å‡º</option>
                </select>
            </div>
            <div>
                <label>é‡‘é¡ *:</label>
                <input type="number" id="amount" step="0.01" min="0.01" required placeholder="ä¾‹å¦‚: 1000">
            </div>
            <div>
                <label>æ—¥æœŸ *:</label>
                <input type="date" id="date" required>
            </div>
            <div>
                <label>åˆ†é¡:</label>
                <input type="text" id="category" placeholder="ä¾‹å¦‚: å­¸è²»">
            </div>
            <div>
                <label>æè¿°:</label>
                <textarea id="description" placeholder="è©³ç´°èªªæ˜"></textarea>
            </div>
            <div>
                <label>å‚™è¨»:</label>
                <textarea id="notes" placeholder="é¡å¤–å‚™è¨»"></textarea>
            </div>
            <div>
                <label>æ”¶æ“š:</label>
                <input type="file" id="receipt" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
            </div>
            <button type="submit">ğŸš€ æäº¤æ¸¬è©¦</button>
            <button type="button" onclick="fillTestData()">ğŸ“ å¡«å…¥æ¸¬è©¦è³‡æ–™</button>
            <button type="button" onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
        </form>
    </div>
    
    <div class="test-section">
        <h3>ğŸ“Š æ¸¬è©¦çµæœ</h3>
        <div id="results"></div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ”§ å¿«é€Ÿæ¸¬è©¦</h3>
        <button onclick="testAuth()">ğŸ” æ¸¬è©¦ç™»å…¥ç‹€æ…‹</button>
        <button onclick="testSummary()">ğŸ“ˆ æ¸¬è©¦è²¡å‹™æ‘˜è¦</button>
        <button onclick="testRecords()">ğŸ“‹ æ¸¬è©¦è¨˜éŒ„åˆ—è¡¨</button>
    </div>

    <script>
        // è¨­å®šä»Šå¤©çš„æ—¥æœŸ
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        
        // å¡«å…¥æ¸¬è©¦è³‡æ–™
        function fillTestData() {
            document.getElementById('type').value = 'income';
            document.getElementById('amount').value = '1000';
            document.getElementById('category').value = 'æ¸¬è©¦åˆ†é¡';
            document.getElementById('description').value = 'æ¸¬è©¦æ”¶å…¥è¨˜éŒ„';
            document.getElementById('notes').value = 'æ¸¬è©¦å‚™è¨»';
            log('info', 'å·²å¡«å…¥æ¸¬è©¦è³‡æ–™');
        }
        
        // æ¸…é™¤çµæœ
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        // è¨˜éŒ„è¨Šæ¯
        function log(type, message, data = null) {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            if (data) {
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(data, null, 2);
                logEntry.appendChild(pre);
            }
            
            results.appendChild(logEntry);
            results.scrollTop = results.scrollHeight;
        }
        
        // æ¸¬è©¦ç™»å…¥ç‹€æ…‹
        async function testAuth() {
            try {
                log('info', 'ğŸ” æ¸¬è©¦ç™»å…¥ç‹€æ…‹...');
                const response = await fetch('/api/finance/summary', {
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    log('warning', 'âš ï¸ ç”¨æˆ¶æœªç™»å…¥');
                } else if (response.ok) {
                    const data = await response.json();
                    log('success', 'âœ… ç”¨æˆ¶å·²ç™»å…¥', data);
                } else {
                    log('error', `âŒ è«‹æ±‚å¤±æ•—: ${response.status}`);
                }
            } catch (error) {
                log('error', 'âŒ ç¶²è·¯éŒ¯èª¤', error.message);
            }
        }
        
        // æ¸¬è©¦è²¡å‹™æ‘˜è¦
        async function testSummary() {
            try {
                log('info', 'ğŸ“ˆ æ¸¬è©¦è²¡å‹™æ‘˜è¦...');
                const response = await fetch('/api/finance/summary', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('success', 'âœ… è²¡å‹™æ‘˜è¦ç²å–æˆåŠŸ', data);
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    log('error', `âŒ è²¡å‹™æ‘˜è¦ç²å–å¤±æ•—: ${response.status}`, errorData);
                }
            } catch (error) {
                log('error', 'âŒ ç¶²è·¯éŒ¯èª¤', error.message);
            }
        }
        
        // æ¸¬è©¦è¨˜éŒ„åˆ—è¡¨
        async function testRecords() {
            try {
                log('info', 'ğŸ“‹ æ¸¬è©¦è¨˜éŒ„åˆ—è¡¨...');
                const response = await fetch('/api/finance/records', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('success', 'âœ… è¨˜éŒ„åˆ—è¡¨ç²å–æˆåŠŸ', {
                        recordCount: data.data?.records?.length || 0,
                        hasData: !!data.data
                    });
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    log('error', `âŒ è¨˜éŒ„åˆ—è¡¨ç²å–å¤±æ•—: ${response.status}`, errorData);
                }
            } catch (error) {
                log('error', 'âŒ ç¶²è·¯éŒ¯èª¤', error.message);
            }
        }
        
        // è¡¨å–®æäº¤
        document.getElementById('testForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            log('info', 'ğŸš€ é–‹å§‹æäº¤æ¸¬è©¦...');
            
            // æ”¶é›†è¡¨å–®è³‡æ–™
            const formData = new FormData();
            formData.append('type', document.getElementById('type').value);
            formData.append('amount', document.getElementById('amount').value);
            formData.append('date', document.getElementById('date').value);
            formData.append('category', document.getElementById('category').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('notes', document.getElementById('notes').value);
            
            const receiptFile = document.getElementById('receipt').files[0];
            if (receiptFile) {
                formData.append('receipt', receiptFile);
                log('info', `ğŸ“ åŒ…å«æ”¶æ“šæª”æ¡ˆ: ${receiptFile.name} (${receiptFile.size} bytes)`);
            }
            
            // è¨˜éŒ„ç™¼é€çš„è³‡æ–™
            const formDataObj = {};
            for (let [key, value] of formData.entries()) {
                if (value instanceof File) {
                    formDataObj[key] = `æª”æ¡ˆ: ${value.name}`;
                } else {
                    formDataObj[key] = value;
                }
            }
            log('info', 'ğŸ“¤ ç™¼é€è³‡æ–™:', formDataObj);
            
            try {
                const response = await fetch('/api/finance/records', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                log('info', `ğŸ“¥ éŸ¿æ‡‰ç‹€æ…‹: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log('success', 'ğŸ‰ æäº¤æˆåŠŸ!', result);
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'ç„¡æ³•è§£æéŒ¯èª¤è¨Šæ¯' }));
                    log('error', 'âŒ æäº¤å¤±æ•—', {
                        status: response.status,
                        error: errorData
                    });
                }
            } catch (error) {
                log('error', 'ğŸ’¥ ç¶²è·¯éŒ¯èª¤', error.message);
            }
        });
        
        // é é¢è¼‰å…¥æ™‚æ¸¬è©¦
        window.addEventListener('load', () => {
            log('info', 'ğŸ æ¸¬è©¦é é¢è¼‰å…¥å®Œæˆ');
            testAuth();
        });
    </script>
</body>
</html> 