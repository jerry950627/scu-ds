<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²¡å‹™ä¸Šå‚³èª¿è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .debug-container { max-width: 1200px; margin: 0 auto; }
        .debug-section { background: white; margin: 15px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-pending { background: #6c757d; }
        .log-entry { margin: 5px 0; padding: 8px; border-left: 3px solid #ddd; background: #f8f9fa; }
        .log-success { border-color: #28a745; }
        .log-error { border-color: #dc3545; color: #721c24; }
        .log-warning { border-color: #ffc107; }
        .log-info { border-color: #17a2b8; }
        pre { background: #f1f1f1; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        #realTimeLog { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #fff; }
        .test-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>ğŸ”§ è²¡å‹™ä¸Šå‚³å•é¡Œèª¿è©¦å·¥å…·</h1>
        
        <div class="debug-section">
            <h2>ğŸ“Š ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h2>
            <div class="test-grid">
                <div>
                    <h4><span class="status-indicator status-pending" id="server-status"></span>æœå‹™å™¨é€£æ¥</h4>
                    <p id="server-info">æª¢æŸ¥ä¸­...</p>
                </div>
                <div>
                    <h4><span class="status-indicator status-pending" id="auth-status"></span>ç”¨æˆ¶èªè­‰</h4>
                    <p id="auth-info">æª¢æŸ¥ä¸­...</p>
                </div>
                <div>
                    <h4><span class="status-indicator status-pending" id="api-status"></span>APIç«¯é»</h4>
                    <p id="api-info">æª¢æŸ¥ä¸­...</p>
                </div>
                <div>
                    <h4><span class="status-indicator status-pending" id="permissions-status"></span>æ¬Šé™æª¢æŸ¥</h4>
                    <p id="permissions-info">æª¢æŸ¥ä¸­...</p>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <h2>ğŸ§ª å¿«é€Ÿæ¸¬è©¦</h2>
            <button class="btn-primary" onclick="runAllTests()">ğŸ”„ é‹è¡Œæ‰€æœ‰æ¸¬è©¦</button>
            <button class="btn-success" onclick="testSimpleSubmit()">ğŸ“¤ æ¸¬è©¦ç°¡å–®æäº¤</button>
            <button class="btn-warning" onclick="testFileUpload()">ğŸ“ æ¸¬è©¦æª”æ¡ˆä¸Šå‚³</button>
            <button class="btn-danger" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
        </div>

        <div class="debug-section">
            <h2>ğŸ“ å³æ™‚æ—¥èªŒ</h2>
            <div id="realTimeLog"></div>
        </div>

        <div class="debug-section">
            <h2>ğŸ” è©³ç´°è¨ºæ–·</h2>
            <div id="diagnosticResults"></div>
        </div>
    </div>

    <script>
        let logContainer;
        
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('realTimeLog');
            log('info', 'ğŸš€ èª¿è©¦å·¥å…·åˆå§‹åŒ–å®Œæˆ');
            runInitialChecks();
        });

        function log(type, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            if (data) {
                const pre = document.createElement('pre');
                pre.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
                logEntry.appendChild(pre);
            }
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(element, status, message) {
            const indicator = document.getElementById(element + '-status');
            const info = document.getElementById(element + '-info');
            
            indicator.className = `status-indicator status-${status}`;
            info.textContent = message;
        }

        async function runInitialChecks() {
            log('info', 'ğŸ” é–‹å§‹åˆå§‹ç³»çµ±æª¢æŸ¥...');
            
            // æª¢æŸ¥æœå‹™å™¨é€£æ¥
            try {
                const response = await fetch('/health', { method: 'GET' });
                if (response.ok) {
                    updateStatus('server', 'success', 'æœå‹™å™¨æ­£å¸¸é‹è¡Œ');
                    log('success', 'âœ… æœå‹™å™¨é€£æ¥æ­£å¸¸');
                } else {
                    updateStatus('server', 'error', `æœå‹™å™¨éŸ¿æ‡‰ç•°å¸¸: ${response.status}`);
                    log('error', 'âŒ æœå‹™å™¨éŸ¿æ‡‰ç•°å¸¸', { status: response.status });
                }
            } catch (error) {
                updateStatus('server', 'error', 'æœå‹™å™¨é€£æ¥å¤±æ•—');
                log('error', 'âŒ æœå‹™å™¨é€£æ¥å¤±æ•—', error.message);
            }

            // æª¢æŸ¥ç”¨æˆ¶èªè­‰
            try {
                const response = await fetch('/api/finance/summary', { 
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    updateStatus('auth', 'error', 'ç”¨æˆ¶æœªç™»å…¥');
                    log('error', 'âŒ ç”¨æˆ¶æœªç™»å…¥ - éœ€è¦å…ˆç™»å…¥ç³»çµ±');
                } else if (response.ok) {
                    const data = await response.json();
                    updateStatus('auth', 'success', 'ç”¨æˆ¶å·²ç™»å…¥');
                    log('success', 'âœ… ç”¨æˆ¶èªè­‰æˆåŠŸ', { userLoggedIn: true });
                } else {
                    updateStatus('auth', 'warning', `èªè­‰ç•°å¸¸: ${response.status}`);
                    log('warning', 'âš ï¸ èªè­‰ç‹€æ…‹ç•°å¸¸', { status: response.status });
                }
            } catch (error) {
                updateStatus('auth', 'error', 'èªè­‰æª¢æŸ¥å¤±æ•—');
                log('error', 'âŒ èªè­‰æª¢æŸ¥å¤±æ•—', error.message);
            }

            // æª¢æŸ¥APIç«¯é»
            try {
                const response = await fetch('/api/finance/records', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    updateStatus('api', 'success', 'APIç«¯é»æ­£å¸¸');
                    log('success', 'âœ… APIç«¯é»å¯è¨ªå•');
                } else {
                    updateStatus('api', 'warning', `APIéŸ¿æ‡‰: ${response.status}`);
                    log('warning', 'âš ï¸ APIç«¯é»éŸ¿æ‡‰ç•°å¸¸', { status: response.status });
                }
            } catch (error) {
                updateStatus('api', 'error', 'APIé€£æ¥å¤±æ•—');
                log('error', 'âŒ APIç«¯é»é€£æ¥å¤±æ•—', error.message);
            }

            // æª¢æŸ¥æ¬Šé™
            try {
                const response = await fetch('/api/finance/records', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ test: 'permission-check' })
                });
                
                if (response.status === 401) {
                    updateStatus('permissions', 'error', 'æœªç™»å…¥');
                    log('error', 'âŒ æ¬Šé™æª¢æŸ¥ï¼šæœªç™»å…¥');
                } else if (response.status === 403) {
                    updateStatus('permissions', 'error', 'æ¬Šé™ä¸è¶³');
                    log('error', 'âŒ æ¬Šé™æª¢æŸ¥ï¼šæ¬Šé™ä¸è¶³');
                } else if (response.status === 400) {
                    updateStatus('permissions', 'success', 'æ¬Šé™æ­£å¸¸ï¼ˆé©—è­‰éŒ¯èª¤ï¼‰');
                    log('success', 'âœ… æ¬Šé™æª¢æŸ¥ï¼šæœ‰æ¬Šé™è¨ªå•ï¼ˆè³‡æ–™é©—è­‰éŒ¯èª¤æ˜¯æ­£å¸¸çš„ï¼‰');
                } else {
                    updateStatus('permissions', 'warning', `æœªçŸ¥ç‹€æ…‹: ${response.status}`);
                    log('warning', 'âš ï¸ æ¬Šé™æª¢æŸ¥ï¼šæœªçŸ¥ç‹€æ…‹', { status: response.status });
                }
            } catch (error) {
                updateStatus('permissions', 'error', 'æ¬Šé™æª¢æŸ¥å¤±æ•—');
                log('error', 'âŒ æ¬Šé™æª¢æŸ¥å¤±æ•—', error.message);
            }
        }

        async function testSimpleSubmit() {
            log('info', 'ğŸ§ª é–‹å§‹æ¸¬è©¦ç°¡å–®æäº¤...');
            
            const testData = new FormData();
            testData.append('type', 'income');
            testData.append('amount', '100');
            testData.append('date', new Date().toISOString().split('T')[0]);
            testData.append('category', 'æ¸¬è©¦åˆ†é¡');
            testData.append('description', 'èª¿è©¦æ¸¬è©¦è¨˜éŒ„');
            testData.append('notes', 'é€™æ˜¯ä¸€å€‹èª¿è©¦æ¸¬è©¦');

            try {
                log('info', 'ğŸ“¤ ç™¼é€æ¸¬è©¦è³‡æ–™åˆ°æœå‹™å™¨...');
                
                const response = await fetch('/api/finance/records', {
                    method: 'POST',
                    credentials: 'include',
                    body: testData
                });

                log('info', `ğŸ“¥ æ”¶åˆ°éŸ¿æ‡‰ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);

                if (response.ok) {
                    const result = await response.json();
                    log('success', 'ğŸ‰ ç°¡å–®æäº¤æ¸¬è©¦æˆåŠŸï¼', result);
                } else {
                    const errorText = await response.text();
                    log('error', 'âŒ ç°¡å–®æäº¤æ¸¬è©¦å¤±æ•—', {
                        status: response.status,
                        statusText: response.statusText,
                        response: errorText
                    });
                }
            } catch (error) {
                log('error', 'ğŸ’¥ ç°¡å–®æäº¤æ¸¬è©¦ç¶²è·¯éŒ¯èª¤', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
            }
        }

        async function testFileUpload() {
            log('info', 'ğŸ“ é–‹å§‹æ¸¬è©¦æª”æ¡ˆä¸Šå‚³...');
            
            // å‰µå»ºä¸€å€‹æ¸¬è©¦æª”æ¡ˆ
            const testFile = new File(['æ¸¬è©¦æ”¶æ“šå…§å®¹'], 'test-receipt.txt', {
                type: 'text/plain'
            });

            const testData = new FormData();
            testData.append('type', 'expense');
            testData.append('amount', '50');
            testData.append('date', new Date().toISOString().split('T')[0]);
            testData.append('category', 'æ¸¬è©¦æ”¯å‡º');
            testData.append('description', 'åŒ…å«æª”æ¡ˆçš„æ¸¬è©¦è¨˜éŒ„');
            testData.append('receipt', testFile);

            try {
                log('info', 'ğŸ“¤ ç™¼é€åŒ…å«æª”æ¡ˆçš„æ¸¬è©¦è³‡æ–™...');
                
                const response = await fetch('/api/finance/records', {
                    method: 'POST',
                    credentials: 'include',
                    body: testData
                });

                log('info', `ğŸ“¥ æ”¶åˆ°éŸ¿æ‡‰ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);

                if (response.ok) {
                    const result = await response.json();
                    log('success', 'ğŸ‰ æª”æ¡ˆä¸Šå‚³æ¸¬è©¦æˆåŠŸï¼', result);
                } else {
                    const errorText = await response.text();
                    log('error', 'âŒ æª”æ¡ˆä¸Šå‚³æ¸¬è©¦å¤±æ•—', {
                        status: response.status,
                        response: errorText
                    });
                }
            } catch (error) {
                log('error', 'ğŸ’¥ æª”æ¡ˆä¸Šå‚³æ¸¬è©¦ç¶²è·¯éŒ¯èª¤', error.message);
            }
        }

        async function runAllTests() {
            log('info', 'ğŸ”„ é‹è¡Œæ‰€æœ‰æ¸¬è©¦...');
            clearLogs();
            await runInitialChecks();
            await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’
            await testSimpleSubmit();
            await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’
            await testFileUpload();
            log('info', 'âœ… æ‰€æœ‰æ¸¬è©¦å®Œæˆ');
        }

        function clearLogs() {
            logContainer.innerHTML = '';
            log('info', 'ğŸ—‘ï¸ æ—¥èªŒå·²æ¸…é™¤');
        }

        // ç›£è½ç¶²è·¯éŒ¯èª¤
        window.addEventListener('error', function(event) {
            log('error', 'ğŸ’¥ å…¨åŸŸéŒ¯èª¤æ•ç²', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno
            });
        });

        // ç›£è½æœªè™•ç†çš„PromiseéŒ¯èª¤
        window.addEventListener('unhandledrejection', function(event) {
            log('error', 'ğŸ’¥ æœªè™•ç†çš„PromiseéŒ¯èª¤', {
                reason: event.reason
            });
        });
    </script>
</body>
</html> 